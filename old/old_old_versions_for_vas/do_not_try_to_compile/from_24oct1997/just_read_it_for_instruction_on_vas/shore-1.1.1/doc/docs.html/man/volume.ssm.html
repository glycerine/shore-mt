<!-- Warning: Do not edit this file. -->
<!-- It was created automatically by yam2html.pl 1.3  -->
<!-- on Mon Oct 27 09:41:10 CST 1997 from file manssm/volume.ssm -->
<!DOCTYPE HTML public "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
<TITLE>
ss_m::volume(ssm) -- Shore Reference Manual
</TITLE>
<LINK REV="made" HREF="mailto:solomon@cs.wisc.edu">
</HEAD>

<BODY>

<!-- .so tmac.man.local -->
<H1><A NAME="HRR.0">
generate_new_lvid, create_vol, destroy_vol, add_logical_id_index, has_logical_id_index, get_volume_quota, print_lid_index, vol_root_index, get_du_statistics - Class ss_m Methods for Volume Management

</A></H1><HR>
<H1>
CONTENTS
</H1>
<UL>
<LI>
<A HREF="#HRR.1">SYNOPSIS</A>
</LI>
<LI>
<A HREF="#HRR.2">DESCRIPTION</A>
</LI>
<LI>
<A HREF="#HRR.3">VOLUMES INITIALIZATION METHODS</A>
</LI>
<LI>
<A HREF="#HRR.4">ROOT INDEX METHODS</A>
</LI>
<LI>
<A HREF="#HRR.5">SPACE UTILIZATION METHODS</A>
</LI>
<LI>
<A HREF="#HRR.6">ERRORS</A>
</LI>
<LI>
<A HREF="#HRR.7">TRANSACTION ISSUES</A>
</LI>
<LI>
<A HREF="#HRR.8">EXAMPLES</A>
</LI>
<LI>
<A HREF="#HRR.9">VERSION</A>
</LI>
<LI>
<A HREF="#HRR.10">SPONSORSHIP</A>
</LI>
<LI>
<A HREF="#HRR.11">COPYRIGHT</A>
</LI>
<LI>
<A HREF="#HRR.12">SEE ALSO</A>
</LI></UL><HR>
<H1><A NAME="HRR.1">SYNOPSIS</A></H1>
<BLOCKQUOTE><PRE>
#include &lt;sm_vas.h&gt;  // which includes sm.h

static rc_t 			generate_new_lvid(lvid_t&amp; lvid);
static rc_t			create_vol(
    const char* 		    device_name,
    const lvid_t&amp;		    lvid,
    uint4			    quota_KB,
    bool 			    skip_raw_init = false,
    vid_t			    local_vid = vid_t::null);
static rc_t			destroy_vol(const lvid_t&amp; lvid);
static rc_t			add_logical_id_index(
    const lvid_t&amp; 		    lvid,
    uint4 			    reserved_local, 
    uint4 			    reserved_remote);
static rc_t			has_logical_id_index(
    const lvid_t&amp; 		    lvid,
    bool&amp;			    has_index);
static rc_t    			get_volume_quota(
    const lvid_t&amp;                   lvid, 
    smksize_t&amp;                      quota_KB, 
    smksize_t&amp;                      quota_used_KB);
static rc_t			print_lid_index(const lvid_t&amp; lvid);
static rc_t                  	vol_root_index(
const lvid_t&amp;               	    v,
serial_t&amp;                   	    liid);


// Volume space utilization statistics

static rc_t			get_du_statistics(
    lvid_t 			    vid,
    sm_du_stats_t&amp;		    du,
    bool			    audit = TRUE);
static rc_t			get_du_statistics(
    const lvid_t&amp; 		    vid,
    const serial_t&amp;	 	    serial, 
    sm_du_stats_t&amp; 	    	    du,
    bool			    audit = TRUE);

</PRE></BLOCKQUOTE>
<HR>
<H1><A NAME="HRR.2">DESCRIPTION</A></H1>

The above class
 <strong>ss_m</strong>
methods manage volumes.
<P>
Volumes are a logical unit of storage that are mapped
to devices, which are physical units of storage (corresponding
to disks or disk partitions).
<P>
A volume is identified
uniquely and persistently by a logical volume ID (lvid_t).
Volumes can be used whenever the device they are located
on is mounted by the SSM.  Volumes have a quota.  The
sum of the quotas of all the volumes on a device cannot
exceed the device quota.  Volumes are located on devices.
Device management methods are described in
<A HREF="device.ssm.html"><STRONG>device(ssm)</STRONG></A>.

<P>
The basic steps to begin using a new volume are:
<DL>
<PP>
 
format_dev():
 initialize the device
<PP>
 
mount_dev():
allow use of the device
<PP>
generate_new_lvid: generate a unique ID for the volume
<PP>
create_vol: create a volume on the device
<PP>
add_logical_id_index: add logical ID facility to the volume

</DL>
<HR>
<H1><A NAME="HRR.3">VOLUMES INITIALIZATION METHODS</A></H1>

<P>
<strong>generate_new_lvid(lvid)</strong>
<DL>
<PP>
The
 <strong>generate_new_lvid</strong>
method generates a universally unique volume id
and returns it via
 <em>lvid.</em>
Currently, the ID is generated using the network address of the
server combined with a timestamp.  

<P>
</DL>
<strong>create_vol(device_name, lvid, quota_KB, skip_raw_init, local_vid)</strong>
<DL>
<PP>
The
 <strong>create_vol</strong>
method create_vol creates and formats a new volume on a device.
When a volume is stored on a raw device, formatting it
involves the time consuming step of zero-ing every page.  This is
necessary for correct operation of recovery.  In some situations
(during testing, for example),
this zeroing is unnecessary.  In
this case, setting
 <em>skip_raw_init</em>
to
<strong>true</strong>
disables the zeroing.
Creating a volume make the volume available for use.
The
 <em>local_vid</em>
parameter is only meant to be a temporary hack for those VASs using the
physical ID version of the SSM interface.  Local_vid is used to specify the
local handle that should be when a volume is mounted.  The default value
vid_t::null indicates that the SSM can use any number it wants to use.
<strong>Note:</strong>
currently there is a limit of one volume per device. 


<P>
</DL>
<strong>destroy_vol(lvid)</strong>
<DL>
<PP>
The
 <strong>destroy_vol</strong>
method destroys a volume on a device.
After a 
 <strong>destroy_vol</strong>
the device remains mounted
and another volume can be created on the device.

<P>
</DL>
<strong>add_logical_id_index(lvid, reserved_local, reserved_remote)</strong>
<DL>
<PP>
The
 <strong>add_logical_id_index</strong>
method sets up the logical ID index on volume
 <em>lvid</em>
and should be called after
 <strong>create_vol.</strong>
The logical ID index is used to map
<A HREF="lid.ssm.html">logical ID serial numbers,</A>
type
<strong>serial_t,</strong>
to physical locations on the volume or to IDs
on other volumes.  The 
 <em>reserved_local</em>
parameter reserves a certain number of intra-volume (local) serial
numbers.  The
 <em>reserved_remote</em>
parameter reserves
inter-volume serial numbers.  The reserved serial numbers will not be
allocated by any calls which generate serial numbers and therefore
can be used for other things by the VAS. 

<P>
</DL>
<strong>has_logical_id_index(lvid, has_index)</strong>
<DL>
<PP>
The
 <strong>has_logical_id_index</strong>
method sets
 <em>has_index</em>
to 
<strong>true</strong>
if volume
 <em>lvid</em>
contains a logical ID index.

<P>
</DL>
<strong>print_lid_index(lvid)</strong>
<DL>
<PP>
The
 <strong>print_lid_index</strong>
method is a
debugging function that prints the logical ID index
to standard output.

</DL>
<HR>
<H1><A NAME="HRR.4">ROOT INDEX METHODS</A></H1>

<P>
The root index of a volume is a special B+tree index available on every
volume.  It can be used to store hooks (roots) into the data on
a volume. A common use of a this index is
to  associate a string name with a record, index or file ID
containing information about the contents of the volume.  For example,
in a database system, this might be the ID for the catalog.
The index is accessed just like any other B+tree index.  See
<A HREF="btree.ssm.html"><STRONG>btree(ssm)</STRONG></A>
for more information.
<strong>Note:</strong>
keys with the prefix &quot;SSM_RESERVED&quot; are reserved for
use by the SSM.

<P>
<strong>vol_root_index(lvid, serial)</strong>
<DL>
<PP>
The
 <strong>vol_root_index</strong>
method returns (in 
 <em>serial)</em>
 the serial number (logical ID) of the
<strong>root index</strong>
for volume
 <em>lvid.</em>


</DL>
<HR>
<H1><A NAME="HRR.5">SPACE UTILIZATION METHODS</A></H1>

<P>
The following methods provide disk space utilization
statistics for volumes, files, and indexes.

<P>
<strong>get_volume_quota(lvid, quota_KB, quota_used_KB)</strong>
<DL>
<PP>
The
 <strong>get_volume_quota</strong>
method returns the quota (in K-bytes) in
 <em>quota_KB</em>
and the amount of the quota allocated in
 <em>quota_used_KB,</em>
for volume
 <em>lvid.</em>


<P>
</DL>
<strong>get_du_statistics(lvid, du, audit)</strong>
<DL>
<PP>
The
 <strong>get_du_statistics</strong>
method gathers space utilization statistics for volume
 <em>lvid.</em>
The use of &quot;du&quot; stems from similarity, in purpose, to the &quot;du&quot;
command found on some operating systems.
The statistics are returned in the
 <em>du</em>
parameter.
When the
 <em>audit</em>
parameter is set to
<strong>true,</strong>
 the entire volume is share (SH) locked and the statistics
are audited for correctness.  The error code
<strong>fcINTERNAL</strong>
will be returned at the first sign of an auditing problem.
If 
<strong>fcINTERNAL</strong>
is returned it indicates either there is a problem with
the integrity of the volumes data structures (possibly
indicating inaccessible garbage) or there is a bug in the
auditing code.  
When the
 <em>audit</em>
parameter is set to
<strong>false,</strong>
only an intention-share (IS) locks are obtained on the volume
and all files and indexes.  Therefore the statistics gathering
methods may not see a consistent version of the volume
as things can be changing while statistics are gathered.

<P>
</DL>
<strong>get_du_statistics(lvid, serial, du, audit)</strong>
<DL>
<PP>
The
 <strong>get_du_statistics</strong>
method gathers space utilization statistics for a specific file
or index indicated by the logical ID:
 <em>lvid,</em>
 <em>serial.</em>
The statistics are returned in the
 <em>du</em>
parameter.
The
 <em>audit</em>
parameter works as described in the previous methods except
that it is the index or file that is SH locked when 
 <em>audit</em>
is
<strong>true.</strong>

</DL>
<HR>
<H1><A NAME="HRR.6">ERRORS</A></H1>

All of the above methods return a
 <strong>w_rc_t</strong>
error code.

<P>
See
<A HREF="errors.ssm.html"><STRONG>errors(ssm)</STRONG></A>
for more information on error handling.

<HR>
<H1><A NAME="HRR.7">TRANSACTION ISSUES</A></H1>
<P>
Many of the above methods cannot be run within the scope of
a transaction.  The reason for this restriction is to avoid
the implication that rolling back (aborting) the transaction
would rollback the effect of the method.

TODO

<HR>
<H1><A NAME="HRR.8">EXAMPLES</A></H1>
TODO

<HR>
<H1><A NAME="HRR.9">VERSION</A></H1>
This manual page applies to Version 1.1.1 of the Shore software.
<HR>
<H1><A NAME="HRR.10">SPONSORSHIP</A></H1>
The Shore project is sponsored by the Advanced Research Project Agency, ARPA
order number 018 (formerly 8230), monitored by the U.S. Army Research
Laboratory under contract DAAB07-91-C-Q518.
<HR>
<H1><A NAME="HRR.11">COPYRIGHT</A></H1>
Copyright &#169; 1994, 1995, 1996, 1997,
Computer Sciences Department, University of
Wisconsin -- Madison. All Rights Reserved.
<HR>
<H1><A NAME="HRR.12">SEE ALSO</A></H1>
<A HREF="intro.ssm.html"><STRONG>intro(ssm)</STRONG></A>,
<A HREF="device.ssm.html"><STRONG>device(ssm)</STRONG></A>.

</BODY>
</HTML>
