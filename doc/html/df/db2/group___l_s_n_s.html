<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Shore Storage Manager: How Log Sequence Numbers are Used</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
<link href="../../tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="../../modules.html"><span>Modules</span></a></li>
    <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="../../classes.html"><span>Classes</span></a></li>
    <li><a href="../../files.html"><span>Files</span></a></li>
    <li><a href="../../dirs.html"><span>Directories</span></a></li>
    <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li><a href="../../examples.html"><span>Examples</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<h1>How Log Sequence Numbers are Used<br>
<small>
[<a class="el" href="../../d8/d1e/group___s_s_m_x_c_t.html">Transactions, Locking and Logging</a>]</small>
</h1>
<p>
Collaboration diagram for How Log Sequence Numbers are Used:<center><table><tr><td><img src="../../df/db2/group___l_s_n_s.png" border="0" alt="" usemap="#d5/de6/df_2db2_2group______l__s__n__s_map">
<map name="d5/de6/df_2db2_2group______l__s__n__s_map">
<area href="../../d8/d1e/group___s_s_m_x_c_t.html" shape="rect" coords="5,5,245,32" alt="">
</map></td></tr></table></center>
<hr><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" name="LLR">
Locates Log Records</a></h2>
A log sequence number generally points to a record in the log. It consists of two parts:<ul>
<li>hi(), a.k.a., file(). This is a number that matches a log partition file, e.g., "log.&lt;file&gt;"</li><li>lo(), a.k.a., rba(). This is byte-offset into the log partition, and is the first byte of a log record, or is the first byte after the last log record in the file (where the next log record could be written).</li></ul>
<p>
<dl compact><dt><b>Note:</b></dt><dd>Once the database runs long enough we will run out of partition numbers (only 64k possible). Fortunately, this is a log, so <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a> don't last forever. Eventually things become durable and the log partition file gets reclaimed (deleted). As long as the first partition is gone before the last one fills, we can simply wrap and change the sense of <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a> comparisions.</dd></dl>
<h3><a class="anchor" name="WORK">
Identifying Limit of Partial Rollback</a></h3>
A savepoint (<a class="el" href="../../d1/da9/classsm__save__point__t.html">sm_save_point_t</a>) is an <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a>. It tells how far back a transaction should undo its actions when <a class="el" href="../../d0/d4e/group___s_s_m_s_p.html#g888b894a58102d61794d91758f9032e1">ss_m::rollback_work</a> is called.<h2><a class="anchor" name="PTS">
Page Timestamps</a></h2>
Each page has an <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a> that acts as a timestamp; it is the lsn of the last log record that describes an update to the page.<p>
In recovery, when a page is read in, all log records with sequence numbers less than the page lsn have been applied, and redo of these log records is not necessary.<p>
The storage manager has other special cases: lsn_t(0,1) -- this is in page.cpp, page_p::_format(), and indicates a freshly formatted page with no further updates. <h3><a class="anchor" name="NPCD">
Nominal Page Corruption-Detection</a></h3>
Pages have two copies of their page lsn; one at the head and one at the end of the page. Presumably if the two match, the page is uncorrupted, though that is no guarantee. Certainly if they do not match, something is wrong.<h2><a class="anchor" name="BPFS">
Buffer Pool Frame Status</a></h2>
The buffer pool's control blocks (bfcb_t) contain an <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a>, the "recovery lsn" or rec_lsn. This is a timestamp that can be compared with the page lsns to determine if the copy in the buffer pool is up-to-date or not.<p>
A recovery lsn is a lower bound on the lsn of a log record that updated the page in the frame. A clean page in the buffer pool has a rec_lsn of <a class="el" href="../../d2/d19/classlsn__t.html#7500d912c84458653301cd0fa73145ab">lsn_t::null</a>. Each time a page is fixed in EX mode, the buffer control block ensures that the rec_lsn is not <a class="el" href="../../d2/d19/classlsn__t.html#7500d912c84458653301cd0fa73145ab">lsn_t::null</a>, thereby indicating that this page is probably dirty and needs flushing or, possibly, is being flushed. The rec_lsn is set to the tail of the log at the time the fix is done; this ensures that any log record written for an update to the page has at least the rec_lsn sequence number. There might be several updates to the page before the page is cleaned, so the rec_lsn is indeed a lower bound, and that's all we can know about it.<p>
Special cases of log sequence numbers:<ul>
<li>null: not a valid <a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a></li><li>max: soon to overflow</li><li>lsn(0,1) : used when some pages are formatted. </li></ul>

<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">class &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d2/d19/classlsn__t.html">lsn_t</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Log Sequence Number. See <a class="el" href="../../implnotes.html#LSNS">Log Sequence Numbers</a>.  <a href="../../d2/d19/classlsn__t.html#_details">More...</a><br></td></tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Mon Jan 2 15:14:01 2012 for Shore Storage Manager by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
