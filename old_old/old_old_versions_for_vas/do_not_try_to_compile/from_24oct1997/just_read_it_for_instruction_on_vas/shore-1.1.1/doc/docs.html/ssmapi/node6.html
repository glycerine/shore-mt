<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<!--Converted with LaTeX2HTML 97.1 (release) (July 13th, 1997)
 by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippman, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Crash Recovery Facilities</TITLE>
<META NAME="description" CONTENT="Crash Recovery Facilities">
<META NAME="keywords" CONTENT="ssmapi">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso_8859_1">
<LINK REL="STYLESHEET" HREF="ssmapi.css">
<LINK REL="next" HREF="node7.html">
<LINK REL="previous" HREF="node5.html">
<LINK REL="up" HREF="ssmapi.html">
<LINK REL="next" HREF="node7.html">
</HEAD>
<BODY >
<!--Navigation Panel-->
<A NAME="tex2html191"
 HREF="node7.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="../icons.gif/next_motif.gif"></A> 
<A NAME="tex2html188"
 HREF="ssmapi.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="../icons.gif/up_motif.gif"></A> 
<A NAME="tex2html182"
 HREF="node5.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="../icons.gif/previous_motif.gif"></A> 
<A NAME="tex2html190"
 HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="../icons.gif/contents_motif.gif"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html192"
 HREF="node7.html">Thread Management</A>
<B> Up:</B> <A NAME="tex2html189"
 HREF="ssmapi.html">The Shore Storage Manager Interface</A>
<B> Previous:</B> <A NAME="tex2html183"
 HREF="node5.html">Transaction Facilities</A>
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><strong>Subsections</strong></A>
<UL>
<LI><A NAME="tex2html193"
 HREF="node6.html#SECTION00061000000000000000000">
Logging</A>
<LI><A NAME="tex2html194"
 HREF="node6.html#SECTION00062000000000000000000">
Checkpointing</A>
<LI><A NAME="tex2html195"
 HREF="node6.html#SECTION00063000000000000000000">
Recovery</A>
</UL>
<!--End of Table of Child-Links-->
<HR>
<A NAME="ssmapi:recov">&#160;</A><H1><A NAME="SECTION00060000000000000000000">
Crash Recovery Facilities</A>
</H1>
<P>
The crash recovery facilities of the SSM consist of
logging, checkpointing, and recovery management.
<P><A NAME="ssmapi:logging">&#160;</A><H2><A NAME="SECTION00061000000000000000000">
Logging</A>
</H2>
<P>
Updates performed by transactions are logged so that
the can be rolled back (in the event of a transaction abort)
or restored (in the event of a crash).  Both the old and new values
of an updated location are logged (so-called &quot;undo/redo logging&quot;.
This technique supports buffer management policies with the properties called
&quot;steal&quot;
(a dirty page can be written to disk at any time) and &quot;no force&quot;
(dirty page need not be forced to disk at commit time).
<P>
The log is a sequence of log records.  Currently the log is stored
in Unix files in a special directory (we plan to support using a raw
device partition in the future).  The size and location of the
log is determined by configuration options described in
<A HREF="node3.html#ssmapi:initshut">the initialization section above</A>.
<P>
The proper value for the size of the log depends upon the
expected transaction mix.  More specifically, it depends on the
age of the oldest (longest running) transaction in the system and
the amount of log space used by all active transactions. Here are
some general rules to determine the  amount  of  free  log  space
available in the system.
<P><UL>
<LI> Log records between the first log
record generated by the oldest active transaction and the most
recent log record generated by any transaction must be retained.
<LI> Log records from a transaction are no longer needed
once the transaction has committed or completely aborted and all
updates have made it to disk. Aborting a transaction requires log space,
so extra space is reserved to allow each active transaction to abort.
Enough log space must be available to commit or abort all active
transactions at all times.
<LI> The log must be contiguous.  Thus only log records at the beginning
of the log that meet the previous conditions may be discarded.
<LI> All <TT>ss_m</TT> calls that update records require log space twice
the size of the space updated in the record. All calls that create,
append, or truncate records require log space equal to the size
created, inserted, or deleted. Each log record generated by these calls
(generally one per call) has an overhead of approximately 50 bytes.
<LI> The amount of log space reserved for aborting a transaction is
equal to the amount of log space generated by the transaction.
<LI> When insufficient log space is available for a transaction,
the transaction is aborted.
<LI> The log should be at least 1 Mbyte.
</UL>
<P>
For example, consider a transaction T1 that creates 300 records
of size 2,000 bytes, writes 20 bytes in 100 objects, and is
committed. T1 requires at least 615 Kbytes for the creates and 9 Kbytes
of log space for the writes. Since log space must be reserved to
abort the transaction, the log size must be over 1.248 Mbytes to run
this transaction. Assuming T1 is the only transaction running in the
system, all the log space it uses and reserves becomes available
when it completes.  If another transaction, T2, is started at the
same time as T1, but is still running after T1 is committed, only the
reserved space for T1 is available for other transactions. The portion
of the log used by T1 and T2 is not available until T2 is finished.
<P>
Transactions that fail because of insufficient log space are commonly
those that load a large number of objects into a file during the
creation of a database. A solution to this problem is to load the
file in a series of smaller transactions. When the last transaction
is committed, the load is complete. If the load needs to be aborted,
a separate transaction is run to destroy the file.
<P><A NAME="ssmapi:checkpoints">&#160;</A><H2><A NAME="SECTION00062000000000000000000">
Checkpointing</A>
</H2>
<P>
Checkpoints are taken periodically by the SSM in order to free log
space and shorten recovery time.  Checkpoints are &quot;fuzzy&quot; and
do not require the system to pause while they are completing.
<P><A NAME="ssmapi:recovery">&#160;</A><H2><A NAME="SECTION00063000000000000000000">
Recovery</A>
</H2>
<P>
The SSM recovers from software, operating system,
and CPU failure by restoring updates made by committed transactions
and rolling back all updates by transactions that did not commit by
the time of the crash.
<P>
Recovery has three phases:
<UL>
<LI> Analysis
<P>
During the analysis phase the log is scanned to determine what
transactions were active and which devices were mounted at the
time of the failure.
<LI> Redo
<P>
During the redo phase the devices are remounted and the log is
scanned starting at a location determined by analysis.
The operation recorded in each log record is redone if necessary.
After redo, the database is in the state it was just before the crash.
<LI> Undo
<P>
During the undo phase, all active transactions that had not committed
at the time of the crash
are undone.  The devices are dismounted, and a checkpoint is taken.
<P></UL>
<P>
The time it takes for recovery depends on several
factors, including the number of transactions in progress at  the
time of the failure, the number of log records generated by these
transactions, and the number of log records generated  since  the
last checkpoint.
<P><HR>
<!--Navigation Panel-->
<A NAME="tex2html191"
 HREF="node7.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="../icons.gif/next_motif.gif"></A> 
<A NAME="tex2html188"
 HREF="ssmapi.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="../icons.gif/up_motif.gif"></A> 
<A NAME="tex2html182"
 HREF="node5.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="../icons.gif/previous_motif.gif"></A> 
<A NAME="tex2html190"
 HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="../icons.gif/contents_motif.gif"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html192"
 HREF="node7.html">Thread Management</A>
<B> Up:</B> <A NAME="tex2html189"
 HREF="ssmapi.html">The Shore Storage Manager Interface</A>
<B> Previous:</B> <A NAME="tex2html183"
 HREF="node5.html">Transaction Facilities</A>
<!--End of Navigation Panel-->
<ADDRESS>
<I>This page was generated from LaTeX sources
<BR>10/27/1997 </I>
</ADDRESS>
</BODY>
</HTML>
